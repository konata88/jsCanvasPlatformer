<html>
<head>
</head>
<body>
<canvas id="myCanvas" width="600" height="600" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>

<br>
<button style='font-size: 20px;' id='moveL' onclick="moveL()">L</button> <button  style='font-size: 20px;' id='moveR' onclick="moveR()">R</button>

<button  style='font-size: 20px;' id='moveUp' onclick="moveUp()">U</button>
<script src="level.js"></script>
<script>
let playerAnimation = [];
let totalAnim = 0;

const Player = {x:35, y:30, oldX:35, oldY:10, halfX:2, halfY:4, powerX:0, powerY:0, fall: false, baseX: 35, baseY: 30}


const c = document.getElementById("myCanvas");
const ctx = c.getContext("2d");

let adown = false;
let ddown = false;

const multi = 8;

window.onkeydown = function(e) {
  //console.log('down: '+e.keyCode);
// a - 65; d - 68; space - 32
  kk = e.keyCode
  if (kk === 65) {
      Player.powerX = -50 
      adown = true  
  }
  if (kk === 68) {
      Player.powerX = 50 
      ddown = true  
  } 

  if (kk === 32) { //jump
  
   if (Player.fall === false) {
    Player.powerY = 300
	}
  }  
}

window.onkeyup = function(e) {
// a - 65; d - 68; space - 32
  kk = e.keyCode
  if (kk === 65) {
      adown = false
	  Player.powerX = (ddown) ? 50 : 0
  }  
  if (kk === 68) {
      ddown = false
      Player.powerX = (adown) ? -50 : 0 
  }
}

const getXCoord = (x, halfX) =>  (x * multi) - (halfX * multi);
const getYCoord = (y, halfY) => (600 - (y * multi)) - (halfY * multi);

function drawRect(x, y, halfX, halfY) {
    xCoord = getXCoord(x, halfX) - Player.offsetX;
    yCoord = getYCoord(y, halfY) - Player.offsetY;



    ctx.rect(xCoord, yCoord, (halfX*2) * multi, (halfY*2) * multi);
    //ctx.drawImage(playerAnimation[0], xCoord, yCoord);
    ctx.stroke();	
}

function drawPlayer() {
    xCoord = getXCoord(Player.baseX, Player.halfX)
    yCoord = getYCoord(Player.baseY, Player.halfY)

    xCoordNew = getXCoord(Player.x, Player.halfX)
    yCoordNew = getYCoord(Player.y, Player.halfY)

    Player.offsetX = xCoordNew - xCoord;
    Player.offsetY = yCoordNew - yCoord;

    const aminPic = (totalAnim / 5) >> 0;
    if (adown) {
        //go left animation
    } else if (ddown) {
        //go right animation
    } else {
        //standing
    }
    //ctx.drawImage(playerAnimation[aminPic], xCoord, yCoord);
    ctx.rect(xCoord, yCoord, (Player.halfX*2) * multi, (Player.halfY*2) * multi);
    //ctx.drawImage(playerAnimation[0], xCoord, yCoord);
    ctx.stroke();

    //300 360 - center

    totalAnim++;
    totalAnim = (totalAnim > 14) ? 0 : totalAnim;
}

function Render() {
    ctx.clearRect(0, 0, 600, 600);
    ctx.beginPath();

    console.log('player x= '+Player.x+' y='+Player.y);
    drawPlayer()
	
	for (i = 0; i < obst.length; i++) { 
    drawRect(obst[i].x,obst[i].y, obst[i].halfX, obst[i].halfY)
    }

}


function moveL() {
	Player.powerX = Player.powerX - 100
}

function moveR() {
    Player.powerX = Player.powerX + 100
}

function moveUp() {
    if (Player.fall == false) {
	    Player.powerY = Player.powerY + 300
	}

}

function isCollide(other) {
    if ( Math.abs(Player.x - other.x) >= Player.halfX + other.halfX ) return false;
    if ( Math.abs(Player.y - other.y) >= Player.halfY + other.halfY ) return false;
    return true;
}


function getCollideObject() {
	for (i = 0; i < obst.length; i++) { 
     res = isCollide(obst[i])
	 if (res) { return obst[i];}
    }
	return false
}

let loaded = true;

const t = setInterval(function() {
    if (!loaded) { return false;}

    let minus = 0
	let up = 0
    if (Player.powerX > 0) {
	        minus = Player.powerX / 4		
	}
	
    if (Player.powerX < 0) {
	        minus = Player.powerX / 4		
	}	
	
    if (Player.powerY > 0) {
	    if (Player.powerY < 10) { 
		    Player.powerY = 0
			} else {
	        up = Player.powerY / 4		
	    }

	}	
	
	
	//Player.powerX = Player.powerX - minus
	Player.powerY = Player.powerY - up
	
	Player.y = Player.y + (up/10)

	

    let cld = getCollideObject()
	
	if (cld) {
	    Player.y = Player.oldY
	} else {
	    Player.oldY = Player.y
	}
		Player.x = Player.x + (minus/10)
	    cld = getCollideObject()
	
	if (cld) {
		Player.x = Player.oldX

	} else {
		Player.oldX = Player.x
	}
	
	
	//if not ground
	if (Player.y > 4) {
	    if (Player.powerY == 0) { Player.powerY=-50;}
	    up = Player.powerY / 4		
		Player.y = Player.y + (up/10)
		//check obs and ground crossing
		
		
		falling = true
		if ((Player.y < 4)) { 
		
		//мы уже приземлились
		Player.y = 4; 
		
		
		Player.oldY = Player.y
		Player.powerY = 0;
		falling = false
        Player.fall = false
		}
		
		
		cld = getCollideObject()
		
		if (cld) { 
		    //мы уже приземлились
			//если мы падаем вниз
			if (up<0) {
		        Player.y = cld.y + cld.halfY +Player.halfY; //тут должны быть координаты граунда или обьекта
			} else { Player.y = cld.y - cld.halfY - Player.halfY }
		
		    Player.oldY = Player.y
		    Player.powerY = 0;
		    falling = false
            Player.fall = false
		}		
		
		
		
		
		if (falling) {
		    Player.fall = true
		    Player.oldY = Player.y
		    Player.powerY = Player.powerY - 50;
		}
		
		if (Player.powerY < -200) {   //max falling speed
		Player.powerY = -200  
		}
		
	} else {Player.powerY = 0;}

	
	
    Render();
},50);

//load images
(async () => {
    playerAnimation[0] = new Image();
    playerAnimation[0].src = "1.bmp";
    await playerAnimation[0].decode();

    playerAnimation[1] = new Image();
    playerAnimation[1].src = "2.bmp";
    await playerAnimation[1].decode();

    playerAnimation[2] = new Image();
    playerAnimation[2].src = "3.bmp";
    await playerAnimation[2].decode();
    loaded = true;
    // img is ready to use
    Render()
})();



//drawRect(2,4,2,4)
//drawRect(1,0,1,1)

</script> 
</body>
</html>